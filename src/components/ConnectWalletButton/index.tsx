import { Button, Menu } from '@mui/material';
import MenuItem from '@mui/material/MenuItem';
import { ConnectType, useConnectedWallet, useWallet } from '@terra-money/wallet-provider';
import { useEffect, useState } from 'react';
import './ConnectWalletButton.scss';
import AddressComponent from './../AddressComponent';
import AccountBalanceWalletIcon from '@mui/icons-material/AccountBalanceWallet';
import ContentCopyIcon from '@mui/icons-material/ContentCopy';
import { useSnackbar } from 'notistack';
import { getServiceInfo } from '../../contract/query';
import { AdminPanelSettings } from '@mui/icons-material';
import { useNavigate } from 'react-router-dom';
import PersonIcon from '@mui/icons-material/Person';

function ConnectWalletButton() {
    const { enqueueSnackbar } = useSnackbar();
    const {
        availableConnectTypes,
        availableInstallTypes,
        connect,
        install,
        disconnect,
    } = useWallet()
    const connectedWallet = useConnectedWallet();
    const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null);
    const [isAdmin, setAdmin] = useState<boolean>(false);
    const open = Boolean(anchorEl);

    useEffect(()=>{
        const preFetch = async () => {
          let isAdmin = false;
          try {
            if (connectedWallet && connectedWallet.walletAddress) {
                let serviceInfo = await getServiceInfo(connectedWallet)
                isAdmin = ( connectedWallet.walletAddress == serviceInfo.admin_address ) 
            }
            else {
              isAdmin = false;
            }
          } catch (e) {
            isAdmin = false;
          }
          setAdmin(isAdmin);
      }
      preFetch()
    })

    const handleClick = (event: React.MouseEvent<HTMLElement>) => {

        

        if ( !connectedWallet && availableConnectTypes.indexOf(ConnectType.EXTENSION) > -1) {
            connect(ConnectType.EXTENSION);
        }

        if ( !connectedWallet && availableInstallTypes.indexOf(ConnectType.EXTENSION) > -1) {
            install(ConnectType.EXTENSION);
        }

        if ( connectedWallet ) {
            disconnect();
        }


        // setAnchorEl(event.currentTarget);
    };

    const handleConnect = (option: ConnectType) => {
        connect(option);
        setAnchorEl(null);
    };

    const handleInstall = (option: ConnectType) => {
        install(option);
        setAnchorEl(null);
    };

    const onCopyAddress = () => {
        if (connectedWallet) {
            navigator.clipboard.writeText(connectedWallet.terraAddress);
            enqueueSnackbar(`Address copied successfully`, { variant: "success" });
            setAnchorEl(null);
        }
    }

    const onDisconnectWallet = () => {
        disconnect();
        setAnchorEl(null);
    }

    const navigate = useNavigate();
    const moveAdmin = () => navigate("/admin")

    return (
        <div className="ConnectWalletButton logo-img">
            {isAdmin && <Button id="AdminPanelButtonMenu"
                variant="outlined"
                aria-controls={open ? 'ConnectWalletOptions' : undefined}
                aria-expanded={open ? 'true' : undefined}
                disableRipple
                onClick={moveAdmin}>
                {connectedWallet && <>
                    <AdminPanelSettings fontSize="inherit" />
                    <AddressComponent maxWidth='120px' address="Admin Panel" />
                </>
                }
            </Button>
        }

        {/* <Button className="logo-img bg-transparent" onClick={handleClick}>
            <svg width="235" height="48" viewBox="0 0 235 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g filter="url(#filter0_b_56_32)">
                <rect width="235" height="48" rx="10" fill="black"/>
                <rect x="0.5" y="0.5" width="234" height="47" rx="9.5" stroke="#FAD64B"/>
                </g>
                <path d="M59.9336 26.3223H62.6191C62.5475 27.2728 62.2839 28.1159 61.8281 28.8516C61.3724 29.5807 60.7376 30.1536 59.9238 30.5703C59.11 30.987 58.1237 31.1953 56.9648 31.1953C56.0729 31.1953 55.2689 31.0391 54.5527 30.7266C53.8431 30.4076 53.2344 29.9551 52.7266 29.3691C52.2253 28.7767 51.8411 28.0671 51.5742 27.2402C51.3073 26.4069 51.1738 25.4727 51.1738 24.4375V23.3535C51.1738 22.3184 51.3105 21.3841 51.584 20.5508C51.8574 19.7174 52.248 19.0078 52.7559 18.4219C53.2702 17.8294 53.8854 17.3737 54.6016 17.0547C55.3242 16.7357 56.1315 16.5762 57.0234 16.5762C58.1823 16.5762 59.1621 16.791 59.9629 17.2207C60.7637 17.6439 61.3854 18.2266 61.8281 18.9688C62.2708 19.7109 62.5378 20.5638 62.6289 21.5273H59.9434C59.8913 20.9284 59.7611 20.4206 59.5527 20.0039C59.3509 19.5872 59.0449 19.2715 58.6348 19.0566C58.2311 18.8353 57.694 18.7246 57.0234 18.7246C56.5026 18.7246 56.0436 18.8223 55.6465 19.0176C55.2559 19.2129 54.9303 19.5059 54.6699 19.8965C54.4095 20.2806 54.2142 20.7624 54.084 21.3418C53.9538 21.9147 53.8887 22.5788 53.8887 23.334V24.4375C53.8887 25.1602 53.9473 25.8079 54.0645 26.3809C54.1816 26.9538 54.3639 27.4388 54.6113 27.8359C54.8587 28.2331 55.1777 28.5358 55.5684 28.7441C55.959 28.9525 56.4245 29.0566 56.9648 29.0566C57.6224 29.0566 58.1562 28.9525 58.5664 28.7441C58.9831 28.5358 59.2988 28.2298 59.5137 27.8262C59.735 27.4225 59.875 26.9212 59.9336 26.3223ZM64.0449 25.8242V25.6191C64.0449 24.8444 64.1556 24.1315 64.377 23.4805C64.5983 22.8229 64.9206 22.2533 65.3438 21.7715C65.7669 21.2897 66.2845 20.9154 66.8965 20.6484C67.5085 20.375 68.2051 20.2383 68.9863 20.2383C69.7806 20.2383 70.4837 20.375 71.0957 20.6484C71.7142 20.9154 72.235 21.2897 72.6582 21.7715C73.0814 22.2533 73.4036 22.8229 73.625 23.4805C73.8464 24.1315 73.957 24.8444 73.957 25.6191V25.8242C73.957 26.5924 73.8464 27.3053 73.625 27.9629C73.4036 28.6139 73.0814 29.1836 72.6582 29.6719C72.235 30.1536 71.7174 30.528 71.1055 30.7949C70.4935 31.0618 69.7936 31.1953 69.0059 31.1953C68.2246 31.1953 67.5247 31.0618 66.9062 30.7949C66.2878 30.528 65.7669 30.1536 65.3438 29.6719C64.9206 29.1836 64.5983 28.6139 64.377 27.9629C64.1556 27.3053 64.0449 26.5924 64.0449 25.8242ZM66.623 25.6191V25.8242C66.623 26.2865 66.6686 26.7194 66.7598 27.123C66.8509 27.5267 66.9909 27.8815 67.1797 28.1875C67.3685 28.4935 67.6126 28.7344 67.9121 28.9102C68.2181 29.0794 68.5827 29.1641 69.0059 29.1641C69.4225 29.1641 69.7806 29.0794 70.0801 28.9102C70.3796 28.7344 70.6237 28.4935 70.8125 28.1875C71.0078 27.8815 71.151 27.5267 71.2422 27.123C71.3333 26.7194 71.3789 26.2865 71.3789 25.8242V25.6191C71.3789 25.1634 71.3333 24.737 71.2422 24.3398C71.151 23.9362 71.0078 23.5814 70.8125 23.2754C70.6237 22.9629 70.3763 22.7188 70.0703 22.543C69.7708 22.3607 69.4095 22.2695 68.9863 22.2695C68.5697 22.2695 68.2116 22.3607 67.9121 22.543C67.6126 22.7188 67.3685 22.9629 67.1797 23.2754C66.9909 23.5814 66.8509 23.9362 66.7598 24.3398C66.6686 24.737 66.623 25.1634 66.623 25.6191ZM78.3613 22.6895V31H75.7832V20.4336H78.2051L78.3613 22.6895ZM77.9512 25.3359H77.1895C77.196 24.5677 77.3001 23.8711 77.502 23.2461C77.7038 22.6211 77.987 22.084 78.3516 21.6348C78.7227 21.1855 79.1621 20.8405 79.6699 20.5996C80.1777 20.3587 80.7441 20.2383 81.3691 20.2383C81.877 20.2383 82.3359 20.3099 82.7461 20.4531C83.1562 20.5964 83.5078 20.8242 83.8008 21.1367C84.1003 21.4492 84.3281 21.8594 84.4844 22.3672C84.6471 22.8685 84.7285 23.487 84.7285 24.2227V31H82.1309V24.2031C82.1309 23.7214 82.0592 23.3405 81.916 23.0605C81.7793 22.7806 81.5775 22.582 81.3105 22.4648C81.0501 22.3477 80.7279 22.2891 80.3438 22.2891C79.9466 22.2891 79.5983 22.3704 79.2988 22.5332C79.0059 22.6895 78.7585 22.9076 78.5566 23.1875C78.3613 23.4674 78.2116 23.7897 78.1074 24.1543C78.0033 24.5189 77.9512 24.9128 77.9512 25.3359ZM89.5332 22.6895V31H86.9551V20.4336H89.377L89.5332 22.6895ZM89.123 25.3359H88.3613C88.3678 24.5677 88.472 23.8711 88.6738 23.2461C88.8757 22.6211 89.1589 22.084 89.5234 21.6348C89.8945 21.1855 90.334 20.8405 90.8418 20.5996C91.3496 20.3587 91.916 20.2383 92.541 20.2383C93.0488 20.2383 93.5078 20.3099 93.918 20.4531C94.3281 20.5964 94.6797 20.8242 94.9727 21.1367C95.2721 21.4492 95.5 21.8594 95.6562 22.3672C95.819 22.8685 95.9004 23.487 95.9004 24.2227V31H93.3027V24.2031C93.3027 23.7214 93.2311 23.3405 93.0879 23.0605C92.9512 22.7806 92.7493 22.582 92.4824 22.4648C92.222 22.3477 91.8997 22.2891 91.5156 22.2891C91.1185 22.2891 90.7702 22.3704 90.4707 22.5332C90.1777 22.6895 89.9303 22.9076 89.7285 23.1875C89.5332 23.4674 89.3835 23.7897 89.2793 24.1543C89.1751 24.5189 89.123 24.9128 89.123 25.3359ZM102.922 31.1953C102.121 31.1953 101.402 31.0651 100.764 30.8047C100.126 30.5443 99.582 30.1829 99.1328 29.7207C98.6901 29.252 98.3483 28.7083 98.1074 28.0898C97.873 27.4648 97.7559 26.7943 97.7559 26.0781V25.6875C97.7559 24.8737 97.873 24.1348 98.1074 23.4707C98.3418 22.8001 98.6738 22.224 99.1035 21.7422C99.5332 21.2604 100.048 20.8893 100.646 20.6289C101.245 20.3685 101.906 20.2383 102.629 20.2383C103.378 20.2383 104.038 20.3652 104.611 20.6191C105.184 20.8665 105.663 21.2181 106.047 21.6738C106.431 22.1296 106.721 22.6764 106.916 23.3145C107.111 23.946 107.209 24.6458 107.209 25.4141V26.498H98.9277V24.7207H104.67V24.5254C104.657 24.1152 104.579 23.7409 104.436 23.4023C104.292 23.0573 104.071 22.7839 103.771 22.582C103.472 22.3737 103.085 22.2695 102.609 22.2695C102.225 22.2695 101.89 22.3542 101.604 22.5234C101.324 22.6862 101.089 22.9206 100.9 23.2266C100.718 23.526 100.581 23.8841 100.49 24.3008C100.399 24.7174 100.354 25.1797 100.354 25.6875V26.0781C100.354 26.5208 100.412 26.931 100.529 27.3086C100.653 27.6862 100.832 28.015 101.066 28.2949C101.307 28.5684 101.594 28.7832 101.926 28.9395C102.264 29.0892 102.648 29.1641 103.078 29.1641C103.618 29.1641 104.107 29.0599 104.543 28.8516C104.986 28.6367 105.37 28.321 105.695 27.9043L106.994 29.252C106.773 29.5775 106.473 29.89 106.096 30.1895C105.725 30.4889 105.275 30.7331 104.748 30.9219C104.221 31.1042 103.612 31.1953 102.922 31.1953ZM113.273 29.1641C113.638 29.1641 113.964 29.0924 114.25 28.9492C114.536 28.806 114.764 28.6042 114.934 28.3438C115.109 28.0833 115.204 27.7806 115.217 27.4355H117.648C117.635 28.1517 117.434 28.793 117.043 29.3594C116.652 29.9258 116.132 30.375 115.48 30.707C114.836 31.0326 114.113 31.1953 113.312 31.1953C112.499 31.1953 111.789 31.0586 111.184 30.7852C110.578 30.5117 110.074 30.1309 109.67 29.6426C109.273 29.1543 108.973 28.5879 108.771 27.9434C108.576 27.2988 108.479 26.6087 108.479 25.873V25.5605C108.479 24.8249 108.576 24.1348 108.771 23.4902C108.973 22.8457 109.273 22.2793 109.67 21.791C110.074 21.3027 110.578 20.9219 111.184 20.6484C111.789 20.375 112.495 20.2383 113.303 20.2383C114.156 20.2383 114.904 20.4043 115.549 20.7363C116.2 21.0684 116.708 21.5371 117.072 22.1426C117.443 22.748 117.635 23.4609 117.648 24.2812H115.217C115.204 23.9036 115.119 23.5651 114.963 23.2656C114.807 22.9661 114.585 22.7253 114.299 22.543C114.012 22.3607 113.664 22.2695 113.254 22.2695C112.818 22.2695 112.453 22.3607 112.16 22.543C111.874 22.7253 111.649 22.9759 111.486 23.2949C111.33 23.6074 111.219 23.959 111.154 24.3496C111.096 24.7337 111.066 25.1374 111.066 25.5605V25.873C111.066 26.3027 111.096 26.7129 111.154 27.1035C111.219 27.4941 111.33 27.8457 111.486 28.1582C111.649 28.4642 111.874 28.7083 112.16 28.8906C112.453 29.0729 112.824 29.1641 113.273 29.1641ZM124.367 20.4336V22.2891H118.312V20.4336H124.367ZM119.934 17.8359H122.521V27.9531C122.521 28.2656 122.564 28.5065 122.648 28.6758C122.733 28.8451 122.86 28.959 123.029 29.0176C123.199 29.0762 123.4 29.1055 123.635 29.1055C123.804 29.1055 123.96 29.0957 124.104 29.0762C124.247 29.0566 124.367 29.0371 124.465 29.0176L124.475 30.9512C124.26 31.0228 124.016 31.0814 123.742 31.127C123.475 31.1725 123.173 31.1953 122.834 31.1953C122.255 31.1953 121.747 31.0977 121.311 30.9023C120.874 30.7005 120.536 30.3783 120.295 29.9355C120.054 29.4863 119.934 28.8939 119.934 28.1582V17.8359ZM134.758 28.2754L137.59 16.7812H139.123L139.221 19.2031L136.193 31H134.572L134.758 28.2754ZM132.971 16.7812L135.295 28.2363V31H133.527L130.305 16.7812H132.971ZM142.16 28.1875L144.445 16.7812H147.121L143.898 31H142.131L142.16 28.1875ZM139.855 16.7812L142.688 28.3145L142.854 31H141.232L138.215 19.1934L138.332 16.7812H139.855ZM154.113 28.7539V23.8809C154.113 23.5228 154.051 23.2135 153.928 22.9531C153.804 22.6927 153.615 22.4909 153.361 22.3477C153.107 22.2044 152.785 22.1328 152.395 22.1328C152.049 22.1328 151.747 22.1914 151.486 22.3086C151.232 22.4258 151.037 22.5918 150.9 22.8066C150.764 23.015 150.695 23.2559 150.695 23.5293H148.107C148.107 23.0931 148.212 22.6797 148.42 22.2891C148.628 21.8919 148.924 21.5404 149.309 21.2344C149.699 20.9219 150.165 20.6777 150.705 20.502C151.252 20.3262 151.864 20.2383 152.541 20.2383C153.342 20.2383 154.055 20.375 154.68 20.6484C155.311 20.9154 155.806 21.319 156.164 21.8594C156.529 22.3997 156.711 23.0801 156.711 23.9004V28.5098C156.711 29.0371 156.743 29.4896 156.809 29.8672C156.88 30.2383 156.984 30.5605 157.121 30.834V31H154.494C154.37 30.7331 154.276 30.3945 154.211 29.9844C154.146 29.5677 154.113 29.1576 154.113 28.7539ZM154.475 24.5645L154.494 26.0977H152.863C152.46 26.0977 152.105 26.14 151.799 26.2246C151.493 26.3027 151.242 26.4199 151.047 26.5762C150.852 26.7259 150.705 26.9082 150.607 27.123C150.51 27.3314 150.461 27.569 150.461 27.8359C150.461 28.0964 150.52 28.3307 150.637 28.5391C150.76 28.7474 150.936 28.9134 151.164 29.0371C151.398 29.1543 151.672 29.2129 151.984 29.2129C152.44 29.2129 152.837 29.1217 153.176 28.9395C153.514 28.7507 153.778 28.5228 153.967 28.2559C154.156 27.9889 154.257 27.735 154.27 27.4941L155.012 28.6074C154.921 28.8743 154.784 29.1576 154.602 29.457C154.419 29.7565 154.185 30.0365 153.898 30.2969C153.612 30.5573 153.267 30.7721 152.863 30.9414C152.46 31.1107 151.991 31.1953 151.457 31.1953C150.773 31.1953 150.161 31.0586 149.621 30.7852C149.081 30.5117 148.654 30.1374 148.342 29.6621C148.029 29.1868 147.873 28.6465 147.873 28.041C147.873 27.4811 147.977 26.9863 148.186 26.5566C148.394 26.127 148.703 25.7656 149.113 25.4727C149.523 25.1732 150.031 24.9486 150.637 24.7988C151.249 24.6426 151.949 24.5645 152.736 24.5645H154.475ZM161.77 16V31H159.182V16H161.77ZM166.965 16V31H164.377V16H166.965ZM174.172 31.1953C173.371 31.1953 172.652 31.0651 172.014 30.8047C171.376 30.5443 170.832 30.1829 170.383 29.7207C169.94 29.252 169.598 28.7083 169.357 28.0898C169.123 27.4648 169.006 26.7943 169.006 26.0781V25.6875C169.006 24.8737 169.123 24.1348 169.357 23.4707C169.592 22.8001 169.924 22.224 170.354 21.7422C170.783 21.2604 171.298 20.8893 171.896 20.6289C172.495 20.3685 173.156 20.2383 173.879 20.2383C174.628 20.2383 175.288 20.3652 175.861 20.6191C176.434 20.8665 176.913 21.2181 177.297 21.6738C177.681 22.1296 177.971 22.6764 178.166 23.3145C178.361 23.946 178.459 24.6458 178.459 25.4141V26.498H170.178V24.7207H175.92V24.5254C175.907 24.1152 175.829 23.7409 175.686 23.4023C175.542 23.0573 175.321 22.7839 175.021 22.582C174.722 22.3737 174.335 22.2695 173.859 22.2695C173.475 22.2695 173.14 22.3542 172.854 22.5234C172.574 22.6862 172.339 22.9206 172.15 23.2266C171.968 23.526 171.831 23.8841 171.74 24.3008C171.649 24.7174 171.604 25.1797 171.604 25.6875V26.0781C171.604 26.5208 171.662 26.931 171.779 27.3086C171.903 27.6862 172.082 28.015 172.316 28.2949C172.557 28.5684 172.844 28.7832 173.176 28.9395C173.514 29.0892 173.898 29.1641 174.328 29.1641C174.868 29.1641 175.357 29.0599 175.793 28.8516C176.236 28.6367 176.62 28.321 176.945 27.9043L178.244 29.252C178.023 29.5775 177.723 29.89 177.346 30.1895C176.975 30.4889 176.525 30.7331 175.998 30.9219C175.471 31.1042 174.862 31.1953 174.172 31.1953ZM185.188 20.4336V22.2891H179.133V20.4336H185.188ZM180.754 17.8359H183.342V27.9531C183.342 28.2656 183.384 28.5065 183.469 28.6758C183.553 28.8451 183.68 28.959 183.85 29.0176C184.019 29.0762 184.221 29.1055 184.455 29.1055C184.624 29.1055 184.781 29.0957 184.924 29.0762C185.067 29.0566 185.188 29.0371 185.285 29.0176L185.295 30.9512C185.08 31.0228 184.836 31.0814 184.562 31.127C184.296 31.1725 183.993 31.1953 183.654 31.1953C183.075 31.1953 182.567 31.0977 182.131 30.9023C181.695 30.7005 181.356 30.3783 181.115 29.9355C180.874 29.4863 180.754 28.8939 180.754 28.1582V17.8359Z" fill="#FAD64B"/>
                <defs>
                <filter id="filter0_b_56_32" x="-100" y="-100" width="435" height="248" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                <feGaussianBlur in="BackgroundImageFix" stdDeviation="50"/>
                <feComposite in2="SourceAlpha" operator="in" result="effect1_backgroundBlur_56_32"/>
                <feBlend mode="normal" in="SourceGraphic" in2="effect1_backgroundBlur_56_32" result="shape"/>
                </filter>
                </defs>
            </svg>

        </Button> */}
            
            <Button id="ConnectWalletButtonMenu"
                variant="outlined"
                aria-controls={open ? 'ConnectWalletOptions' : undefined}
                aria-expanded={open ? 'true' : undefined}
                
                className={connectedWallet ? "" : "connected"}
                onClick={handleClick}>
                {connectedWallet && <>
                    <PersonIcon fontSize="inherit" />
                    <AddressComponent maxWidth='120px' address={connectedWallet.terraAddress} />
                </>
                }
                <span>{!connectedWallet && "Connect Wallet"}</span>
            </Button>

            <Menu id="ConnectWalletOptions"
                MenuListProps={{ 'aria-labelledby': 'ConnectWalletButtonMenu' }}
                anchorEl={anchorEl}
                open={open}
                onClose={() => setAnchorEl(null)}>
                {!connectedWallet && availableConnectTypes.map((option) => (
                    <MenuItem key={option}
                        onClick={() => handleConnect(option)}>
                        {option}
                    </MenuItem>
                ))}


                {!connectedWallet && availableInstallTypes.map((option) => (
                    <MenuItem key={option}
                        onClick={() => handleInstall(option)}>
                        {option}
                    </MenuItem>
                ))}

                {connectedWallet && [
                    <MenuItem key="random1" onClick={() => onCopyAddress()}>
                        <span className="CopyEntry">
                            <ContentCopyIcon />
                            <span>Copy Address</span>
                        </span>
                    </MenuItem>,
                    <MenuItem key="random2" onClick={() => onDisconnectWallet()}>
                        Disconnect
                    </MenuItem>
                ]}
            </Menu>
        </div>
    );
}

export default ConnectWalletButton;